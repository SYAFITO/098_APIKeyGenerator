<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
</head>

<style>
  #dashboard { display: none; }
  #loginPage { display: block; }
  .pointer { cursor: pointer; }
</style>

<body>

<!-- =================== LOGIN =================== -->
<div id="loginPage" class="container d-flex justify-content-center mt-5">
  <div class="card p-4 shadow" style="width: 400px; border-radius: 15px;">
    <h3 class="text-center mb-3">Admin Login</h3>

    <input id="email" class="form-control mb-2" placeholder="Email">
    <input id="password" type="password" class="form-control mb-3" placeholder="Password">

    <button onclick="loginAdmin()" class="btn btn-primary w-100">Login</button>
  </div>
</div>

<!-- =================== DASHBOARD =================== -->
<div id="dashboard" class="container mt-5">
  <div class="d-flex justify-content-between mb-3">
    <h3>Dashboard API Key</h3>
    <button class="btn btn-danger" onclick="logout()">Logout</button>
  </div>

  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>API Key</th>
        <th>Expires At</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="apikey-table"></tbody>
  </table>
</div>

<script>
// =================== LOGIN ===================
async function loginAdmin() {
  const res = await fetch("/admin/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: document.getElementById("email").value,
      password: document.getElementById("password").value
    })
  });

  const response = await res.json();
  alert(response.msg);

  if (!response.error) {

    // HIDE LOGIN PAGE TOTAL
    const loginPage = document.getElementById("loginPage");
    loginPage.style.display = "none";
    loginPage.innerHTML = ""; // <--- INI AGAR LOGIN HILANG SELURUHNYA

    // SHOW DASHBOARD
    document.getElementById("dashboard").style.display = "block";

    // LOAD DATA
    await loadApiKeys();
  }
}

// =================== LOAD DATA API KEY ===================
async function loadApiKeys() {
  const res = await fetch("/apikeys");
  const data = await res.json();

  const table = document.getElementById("apikey-table");
  table.innerHTML = "";

  data.data.forEach(row => {
    table.innerHTML += `
      <tr>
        <td>${row.id}</td>
        <td>${row.apikey}</td>
        <td>${row.expires_at}</td>
        <td>
            <select id="status-${row.id}" class="form-select">
                <option value="active" ${row.status === "active" ? "selected" : ""}>Active</option>
                <option value="inactive" ${row.status === "inactive" ? "selected" : ""}>Inactive</option>
            </select>
        </td>
        <td>
            <button class="btn btn-success btn-sm" onclick="saveStatus(${row.id})">Save</button>
            <button class="btn btn-danger btn-sm" onclick="deleteKey(${row.id})">Delete</button>
        </td>
      </tr>
    `;
  });
}

// =================== UPDATE STATUS ===================
async function saveStatus(id) {
  const status = document.getElementById(`status-${id}`).value;

  const res = await fetch("/apikey/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, status })
  });

  const response = await res.json();
  alert(response.msg);
}

// =================== DELETE API KEY ===================
async function deleteKey(id) {
  if (!confirm("Yakin ingin menghapus?")) return;

  const res = await fetch("/apikey/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id })
  });

  const response = await res.json();
  alert(response.msg);
  loadApiKeys();
}

// =================== LOGOUT ===================
function logout() {
  location.reload();
}
</script>

</body>
</html>